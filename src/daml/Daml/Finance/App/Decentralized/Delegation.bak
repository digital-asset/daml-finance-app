module DeFi.Delegation where

import DA.Finance.Asset (AssetDeposit, Transfer(..))
import DA.Set (Set)
import DA.Set qualified as S

template ThresholdDelegation with
    providers: Set Party
    owners: Set Party
    threshold: Int
  where
    signatory owners, providers

    ensure S.size owners >= threshold && threshold >= 0

    nonconsuming choice ThresholdDelegation_DirectTransfer: ContractId AssetDeposit
      with
        ownersSubset: Set Party
        newOwners: Set Party
        tokenCid: ContractId AssetDeposit
      controller ownersSubset, newOwners
      do
        assertMsg "sufficiently many owners" ((S.size ownersSubset) >= threshold && (S.null (S.difference ownersSubset owners)))
        exercise tokenCid Transfer with receivers = newOwners